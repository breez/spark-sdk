name: Publish Flutter Bindings
on:
  workflow_call:
    inputs:
      repository:
        description: 'SDK repository, defaults to current repository'
        required: false
        type: string
      ref:
        description: 'Git commit, tag or branch reference'
        required: true
        type: string
      package-version:
        description: 'Version for the Flutter package (MAJOR.MINOR.PATCH) // (no v prefix)'
        required: true
        type: string
      publish:
        description: 'Should publish the package'
        required: true
        type: boolean
        default: false
    secrets:
      REPO_SSH_KEY:
        description: 'SSH key to commit to the breez-sdk-spark-flutter repository'
        required: true
      FLUTTER_RELEASE_TOKEN:
        description: 'GitHub token to release to the breez-sdk-spark-flutter repository'
        required: true
      CARGOKIT_PRIVATE_KEY:
        description: 'Cargokit private key for signing precompiled binaries'
        required: true

env:
  FLUTTER_VERSION: '3.38.5'  
  NDK_VERSION: '23.2.8568313'
  ANDROID_MIN_SDK: '24'
  IPHONEOS_DEPLOYMENT_TARGET: '13.0'
  CARGO_MANIFEST_DIR: '../../rust'
  FLUTTER_PACKAGE_REPO: 'breez/breez-sdk-spark-flutter'

jobs:
  build-package:
    name: Build Flutter Package
    runs-on: ubuntu-latest
    timeout-minutes: 45
    outputs:
      package-version: ${{ inputs.package-version }}
    steps:
      - name: Checkout Flutter Package Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FLUTTER_PACKAGE_REPO }}
          ssh-key: ${{ secrets.REPO_SSH_KEY }}
          fetch-depth: 0
          path: dist
      
      - name: Checkout SDK Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository || github.repository }}
          ref: ${{ inputs.ref || github.sha }}
          path: build
  
      - name: Setup build
        uses: ./build/.github/actions/setup-build
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up just
        uses: extractions/setup-just@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - run: flutter --version

      - name: Update Cargo Dependencies
        working-directory: build/packages/flutter/rust
        run: |
          HASH=$(git rev-parse HEAD)
          sed -i.bak -e 's/^breez-sdk-common = .*/breez-sdk-common = { git = "https:\/\/github.com\/breez\/spark-sdk.git", rev = "'"$HASH"'" }/' Cargo.toml
          sed -i.bak -e 's/^breez-sdk-spark = .*/breez-sdk-spark = { git = "https:\/\/github.com\/breez\/spark-sdk.git", rev = "'"$HASH"'", features = ["openssl-vendored"] }/' Cargo.toml
          rm Cargo.toml.bak

      - name: Install flutter_rust_bridge_codegen
        working-directory: build/packages/flutter
        run: just frb

      - name: Generate Flutter Bindings
        working-directory: build/packages/flutter
        run: just codegen
  
      - name: Prepare Package Structure
        working-directory: dist
        run: |
          # Remove existing directories
          rm -rf android cargokit ios macos lib rust

          # Copy source directories
          cp -r ../build/packages/flutter/{android,cargokit,ios,macos,lib,rust} .

          # Clean up gitignore files
          rm -f {lib,rust}/src/.gitignore

          # Clean up build artifacts
          rm -rf rust/target

          # Copy package metadata
          cp ../build/packages/flutter/*.yaml .

      - name: Copy Documentation
        working-directory: dist
        run: |
          for file in CHANGELOG.md LICENSE README.md; do
            [ -f "../packages/flutter/$file" ] && cp "../packages/flutter/$file" . || echo "Warning: $file not found"
          done

      - name: Update Package Version to Release Version
        working-directory: dist
        run: |
          # Override version with the release version specified in inputs
          # Note: The version script already synced versions in the build directory,
          # but for releases we use the explicit package-version input parameter

          # Update pubspec.yaml
          sed -i.bak -e 's/^version:.*/version: ${{ inputs.package-version }}/' pubspec.yaml

          # Update Android gradle
          sed -i.bak -e "s/^version .*/version '${{ inputs.package-version }}'/" android/build.gradle

          # Update iOS podspec
          sed -i.bak -e "s/version             = .*/version             = '${{ inputs.package-version }}'/" ios/breez_sdk_spark_flutter.podspec

          # Update macOS podspec
          sed -i.bak -e "s/version             = .*/version             = '${{ inputs.package-version }}'/" macos/breez_sdk_spark_flutter.podspec

          # Update Rust Cargo.toml
          sed -i.bak -e 's/^version = ".*"/version = "${{ inputs.package-version }}"/' rust/Cargo.toml

          # Remove backup files
          rm *.bak */*.bak 2>/dev/null || true

      - name: Archive Flutter Package
        uses: actions/upload-artifact@v4
        with:
          name: breez-sdk-spark-flutter-${{ inputs.package-version || github.sha }}
          path: |
            dist/*
            !dist/.git
          retention-days: 30
          compression-level: 9

      - name: Publish Package
        working-directory: dist
        if: ${{ inputs.publish }}
        run: |
          git config user.name "Breez SDK Bot"
          git config user.email "sdk-bot@breez.technology"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: release Flutter package v${{ inputs.package-version }}"
          git push

          git tag "v${{ inputs.package-version }}" -m "Release v${{ inputs.package-version }}"
          git push origin "v${{ inputs.package-version }}"

  precompile-binaries:
    name: Precompile Binaries (${{ matrix.platform }})
    needs: build-package
    if: ${{ inputs.publish }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
            features: android
          - platform: darwin
            os: macOS-latest
            features: ios,macos
    steps:
      - name: Checkout Flutter Package Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FLUTTER_PACKAGE_REPO }}
          ssh-key: ${{ secrets.REPO_SSH_KEY }}
          fetch-depth: 0

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "30.2"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup rust cache
        uses: Swatinem/rust-cache@v2

      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: Install Linux Dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev

      - name: Setup Android Development
        if: matrix.platform == 'linux'
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        if: matrix.platform == 'linux'
        run: sdkmanager "ndk;${{ env.NDK_VERSION }}"

      - name: Set iOS Deployment Target
        if: matrix.platform == 'darwin'
        run: echo "IPHONEOS_DEPLOYMENT_TARGET=${{ env.IPHONEOS_DEPLOYMENT_TARGET }}" >> $GITHUB_ENV

      - name: Precompile Binaries (Linux + Android)
        if: matrix.platform == 'linux'
        working-directory: cargokit/build_tool
        run: |
          dart run build_tool precompile-binaries \
            --verbose \
            --manifest-dir=${{ env.CARGO_MANIFEST_DIR }} \
            --repository=${{ env.FLUTTER_PACKAGE_REPO }} \
            --android-sdk-location=$ANDROID_HOME \
            --android-ndk-version=${{ env.NDK_VERSION }} \
            --android-min-sdk-version=${{ env.ANDROID_MIN_SDK }}
        env:
          GITHUB_TOKEN: ${{ secrets.FLUTTER_RELEASE_TOKEN }}
          PRIVATE_KEY: ${{ secrets.CARGOKIT_PRIVATE_KEY }}

      - name: Precompile Binaries (macOS + iOS)
        if: matrix.platform == 'darwin'
        working-directory: cargokit/build_tool
        run: |
          dart run build_tool precompile-binaries \
            --verbose \
            --manifest-dir=${{ env.CARGO_MANIFEST_DIR }} \
            --repository=${{ env.FLUTTER_PACKAGE_REPO }}
        env:
          GITHUB_TOKEN: ${{ secrets.FLUTTER_RELEASE_TOKEN }}
          PRIVATE_KEY: ${{ secrets.CARGOKIT_PRIVATE_KEY }}

      - name: Validate Binary Compilation
        run: |
          echo "Binary precompilation completed successfully for ${{ matrix.platform }}"